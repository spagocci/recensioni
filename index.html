<!-- =========================================================================
file: public/index.html ‚Äî Spagocci 1.6.0 (riordino + salvataggio con API autodetect)
Uso:
- Locale HTTP: apri questo file con un server statico (o file://) ‚Üí chiama http://localhost:3000
- HTTPS (GitHub Pages, ecc.): passa ?api=https://localhost:3443 e avvia il bot con HTTPS
============================================================================= -->
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Usato Recensioni Davide Spagocci</title>
<link rel="icon" href="https://github.com/spagocci/recensioni/blob/main/icona.png" type="image/png" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding:20px; background:#f9f9f9; }
  button { margin:5px; padding:8px 12px; font-size:1em; cursor:pointer; }
  .contenuto { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
  .item { background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); padding:10px; position:relative; text-align:center; }
  .item img { width:100%; max-width:180px; object-fit:contain; }
  .controls { display:flex; align-items:center; justify-content:center; gap:5px; margin-top:5px; }
  .controls button { font-size:14px; padding:4px 6px; }
  .controls input { width:56px; text-align:center; }
  #salvaOrdine { background:#007a00; color:#fff; border:none; border-radius:10px; padding:10px 18px; font-weight:bold; }
  #salvaOrdine[disabled] { opacity:.6; cursor:not-allowed; }
  #salvaOrdine:hover:not([disabled]) { background:#005a00; }
  #statusMsg { margin:10px 0; font-weight:600; white-space:pre-wrap; }
  .btn-asin { position:absolute; right:6px; top:6px; border:1px solid #b30000; background:#fff; color:#b30000; font-size:10px; padding:3px 5px; border-radius:6px; cursor:pointer; }
  .muted { color:#666; font-weight:400; }
</style>
</head>
<body>
  <h2>üõçÔ∏è Spagocci Vetrina (1.6.0)</h2>
  <div class="muted" id="apiInfo"></div>
  <button id="salvaOrdine">üíæ Salva ordine su GitHub</button>
  <div id="statusMsg"></div>
  <div class="contenuto" id="contenutoVetrina"></div>

<script>
const qs = new URLSearchParams(location.search);
const API_BASE = (() => {
  const manual = qs.get('api');
  if (manual) return manual.replace(/\/+$/, '');
  const isHTTPS = location.protocol === 'https:';
  return isHTTPS ? 'https://localhost:' + (qs.get('tls') || '3443')
                 : 'http://localhost:' + (qs.get('port') || '3000');
})();
document.getElementById('apiInfo').textContent = `API: ${API_BASE}`;

const STATUS = document.getElementById('statusMsg');
const BTN_SAVE = document.getElementById('salvaOrdine');
function setStatus(msg) { STATUS.textContent = msg; }
function setBusy(b) { BTN_SAVE.disabled = b; }

async function getJSON(url) {
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 12000);
  try {
    const res = await fetch(url, { signal: ctrl.signal, cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return await res.json();
  } finally { clearTimeout(t); }
}
async function postJSON(url, body) {
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 15000);
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'cors',
      body: JSON.stringify(body),
      signal: ctrl.signal,
    });
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} ‚Äî ${text.slice(0,300)}`);
    try { return JSON.parse(text); } catch { return { ok:false, error:'JSON parse error', raw:text }; }
  } catch (err) {
    const isMixed = location.protocol === 'https:' && API_BASE.startsWith('http://');
    const hints = [
      isMixed ? 'Mixed content: usa HTTPS per l‚ÄôAPI o apri la pagina in HTTP.' : null,
      'Server spento/porta errata?',
      'CORS disabilitato sul server?',
      err.name === 'AbortError' ? 'Timeout richiesta.' : null,
    ].filter(Boolean).join(' ');
    throw new Error(`${err.message}${hints ? ` | Hint: ${hints}` : ''}`);
  } finally { clearTimeout(t); }
}

async function caricaCatalogo(){
  try {
    const data = await getJSON('https://spagocci.github.io/recensioni/data.json?t=' + Date.now());
    data.sort((a,b)=>(a.position??9999)-(b.position??9999)||new Date(b.timestamp)-new Date(a.timestamp));
    const contenuto = document.getElementById('contenutoVetrina');
    contenuto.innerHTML='';
    data.forEach((item,idx)=>{
      const div=document.createElement('div');
      div.className='item';
      div.dataset.asin=item.asin||'';
      div.dataset.position=item.position || (idx+1);
      div.innerHTML=`
        ${item.image?`<img src="${item.image}" alt="">`:''}
        <p>${item.text||''}</p>
        <div>${item.price||''}</div>
        <div class="controls">
          <button class="move-up">‚¨ÜÔ∏è</button>
          <input type="number" min="1" value="${item.position||idx+1}" class="order-input">
          <button class="move-down">‚¨áÔ∏è</button>
        </div>
        ${item.asin?`<button class="btn-asin" data-asin="${item.asin}">ASIN</button>`:''}
      `;
      contenuto.appendChild(div);
    });
  } catch (e) {
    setStatus(`‚ùå Errore caricamento catalogo: ${e.message}`);
  }
}

document.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const item=btn.closest('.item'); const parent=item?.parentNode; if(!item||!parent) return;
  if(btn.classList.contains('move-up') && item.previousElementSibling){
    parent.insertBefore(item,item.previousElementSibling);
  } else if(btn.classList.contains('move-down') && item.nextElementSibling){
    parent.insertBefore(item.nextElementSibling,item);
  } else if(btn.classList.contains('btn-asin')){
    navigator.clipboard.writeText(btn.dataset.asin);
    btn.textContent='üìã Copiato'; setTimeout(()=>btn.textContent='ASIN',1000);
  }
  aggiornaPosizioni();
});

document.addEventListener('input',e=>{
  if(e.target.classList.contains('order-input')){
    const item=e.target.closest('.item');
    const pos=parseInt(e.target.value,10);
    if(!isNaN(pos)){ item.dataset.position=pos; riordinaPerNumero(); }
  }
});

function aggiornaPosizioni(){
  document.querySelectorAll('.item').forEach((el,i)=>{
    el.dataset.position=i+1;
    el.querySelector('.order-input').value=i+1;
  });
}
function riordinaPerNumero(){
  const container=document.getElementById('contenutoVetrina');
  const items=[...container.children];
  items.sort((a,b)=>parseInt(a.dataset.position)-parseInt(b.dataset.position));
  items.forEach(it=>container.appendChild(it));
}

document.getElementById('salvaOrdine').addEventListener('click',async()=>{
  const ordine=[...document.querySelectorAll('.item')]
    .map(el=>({asin:el.dataset.asin,position:parseInt(el.dataset.position)}))
    .filter(o=>o.asin && !isNaN(o.position));
  try{
    setBusy(true);
    setStatus("‚è≥ Invio ordine al bot‚Ä¶");
    const js = await postJSON(`${API_BASE}/saveorder`, ordine);
    if(js.ok) setStatus(`‚úÖ Ordine salvato su GitHub (${js.modificati} prodotti aggiornati).`);
    else setStatus(`‚ö†Ô∏è Errore dal server: ${js.error || 'upload fallito'}`);
  }catch(e){
    setStatus(`‚ùå Errore invio ordine: ${e.message}`);
  }finally{
    setBusy(false);
  }
});

caricaCatalogo();
</script>
</body>
</html>
