<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spagocci 2.0</title>
<link rel="icon" href="https://www.github.com/spagocci/recensioni/raw/main/icona.png" type="image/png" />
<style>
  body {font-family:sans-serif;padding:20px;background:#f9f9f9;}
  button {margin-bottom:10px;padding:8px 12px;font-size:1em;cursor:pointer;}

  #filtroParole {width:100%;max-width:400px;padding:8px 10px;margin:10px 0;font-size:1em;border:2px solid #b30000;border-radius:10px;box-sizing:border-box;}
  #mostraBox {position:relative;width:100%;max-width:400px;margin:10px 0;}
  #mostraParole {width:100%;padding:8px 10px;font-size:1em;border:2px solid #b30000;border-radius:10px;box-sizing:border-box;}
  #clearMostra {position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#b30000;color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-weight:bold;display:none;line-height:18px;z-index:1;}
  #clearMostra:hover{background:darkred;}

  #statusBar {display:flex;align-items:center;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
  #apiInfo { display: none; } 
  #statusMsg {margin:5px 0;font-weight:600;white-space:pre-wrap;}

  .row {display:flex;flex-wrap:wrap;gap:10px;height:auto;}
  .column {flex:1 1 380px;background:linear-gradient(to bottom,#fff,#f0f0f0);padding:20px;border-radius:20px;border:none;box-shadow:inset 0 0 10px rgba(0,0,0,0.05),0 4px 10px rgba(0,0,0,0.1);overflow-y:auto;}
  .column h2{margin-top:0;}
  .contenuto {display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;padding:0 4px;box-sizing:border-box;}
  .reorder-on .contenuto { grid-template-columns:1fr; gap:14px; }

  .item {background:#fff;border:1px solid #eee;border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;}
  .item-content {text-align:center;position:relative;}
  .item-content a.img-link { display:block; }
  .item-content img {width:100%;max-width:200px;aspect-ratio:1/1;object-fit:contain;}
  .price-big {font-weight:bold;color:#009900;font-size:1em;margin-top:6px;cursor:pointer;}
  .column a {color:#000;text-decoration:none;font-weight:bold;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;line-height:1.2em;}
  .column a:hover{text-decoration:underline;}
  small{color:#666;font-size:0.8em;}

  .controls { display:none; align-items:center; justify-content:center; gap:5px; margin-top:6px; }
  .controls button { font-size:14px; padding:4px 6px; }
  .controls input { width:56px; text-align:center; }
  .btn-asin { display:none; position:absolute; right:6px; top:6px; border:1px solid #b30000; background:#fff; color:#b30000; font-size:10px; padding:3px 5px; border-radius:6px; cursor:pointer; z-index:2; }
  .reorder-on .controls { display:flex; }
  .reorder-on .btn-asin { display:inline-block; }
  .reorder-on { user-select:none; }
  .reorder-on .item-content a { pointer-events:none; }

  .drag-enabled .item { touch-action: pan-y; }
  .reorder-dragging .item { touch-action: none; }
  .ghost-drag { position:fixed; z-index:10000; pointer-events:none; transform:translate(-50%,-50%) scale(1.02); box-shadow:0 10px 25px rgba(0,0,0,0.2); border-radius:12px; background:#fff; }
  .placeholder { border:2px dashed #b30000; border-radius:12px; background:rgba(179,0,0,0.04); }

  img[loading="lazy"] {content-visibility:auto;}

  @media(max-width:768px){
    body{padding:10px;}
    .row{flex-direction:column;}
    .column{flex:1 1 100%;max-width:100%;padding:10px;}
    .contenuto{grid-template-columns:repeat(2,1fr);}
    .reorder-on .contenuto{grid-template-columns:1fr;}
    .item-content img{max-width:110px;}
    .column a{font-size:0.8em;line-height:1.1em;}
    .price-big{font-size:0.9em;}
    small{font-size:0.7em;}
    h2{font-size:0.9em;margin-bottom:5px;}
  }

  /* Console segreta */
  #secretConsole { margin-top:20px; padding:12px; border-top:1px dashed #bbb; }
  #secretForm { display:flex; gap:8px; align-items:center; }
  #secretPrompt { font-weight:600; color:#666; }
  #secretInput { flex:1; max-width:320px; padding:8px 10px; border:2px solid #ccc; border-radius:10px; }
  #secretInput.error { animation: shake .25s linear 2; border-color:#c00; }
  @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-4px)} 100%{transform:translateX(0)} }

  .drag-handle{
    display:none; position:absolute; left:6px; top:6px;
    width:28px; height:28px; line-height:28px; text-align:center;
    border-radius:6px; border:1px solid #bbb; background:#fff;
    font-weight:bold; font-size:16px; cursor:grab;
    box-shadow:0 1px 3px rgba(0,0,0,0.08);
    user-select:none; -webkit-user-select:none;
    touch-action:none;
  }
  .drag-handle:active{ cursor:grabbing; }
  .reorder-on .drag-handle{ display:block; }

  .btn-edit-text{
    position:absolute; right:6px; bottom:6px;
    border:1px solid #888; background:#fff; color:#333;
    font-size:12px; padding:3px 6px; border-radius:6px; cursor:pointer; z-index:2;
    opacity:.9;
  }
  .btn-edit-text:hover{ opacity:1; }

  /* nuovo: bottone Prezzo (solo quando manca il prezzo) */
  .btn-edit-price{
    position:absolute; left:6px; bottom:6px;
    border:1px solid #888; background:#fff; color:#333;
    font-size:12px; padding:3px 6px; border-radius:6px; cursor:pointer; z-index:2;
    opacity:.9;
  }
  .btn-edit-price:hover{ opacity:1; }

  /* clamp per testi/descrizioni */
  .column a,
  .item-content p.desc{
    display:-webkit-box; -webkit-box-orient:vertical;
    overflow:hidden; line-height:1.2em;
    -webkit-line-clamp: var(--line-clamp, 4);
  }

  /* Bottone SALVA unico */
  #salvaTutto { background:#0a7; color:#fff; border:none; border-radius:10px; padding:10px 18px; font-weight:bold; display:none; }
  #salvaTutto[disabled] { opacity:.6; cursor:not-allowed; }
  #salvaTutto:hover:not([disabled]) { background:#086; }
</style>
</head>
<body>
<p class="link-bar">
  <b>
    <a href="https://whatsapp.com/channel/0029Vb6FyJ88qIzyi9nRtV2O">WHATSAPPüì¶</a> -
    <a href="https://www.ebay.it/sch/i.html?_dkr=1&_ssn=davidespagocci">üõçÔ∏èEBAY</a>
  </b>
</p>

<div id="mostraBox">
  <input id="mostraParole" type="text" placeholder="Cerca Parole (es: Cane, Per Lamborghini)üîç">
  <button id="clearMostra">‚ùå</button>
</div>
<input id="filtroParole" type="text" placeholder="Nascondi Parole (es: Custodia, per finestre)üö´">
<button id="toggleAudio">üì¢Notifiche</button>

<div id="statusBar">
  <span id="apiInfo"></span>
  <button id="salvaTutto" title="Salva locale + pubblica su GitHub">üíæ SALVA</button>
  <label style="display:flex;align-items:center;gap:6px;">
    Righe:
    <input id="clampRange" type="range" min="1" max="8" step="1" value="4">
    <span id="clampVal">4</span>
  </label>
</div>
<div id="statusMsg"></div>

<audio id="audioGenerale" src="https://raw.githubusercontent.com/spagocci/recensioni/main/tutti.mp3" preload="auto"></audio>
<audio id="audioPochiSecondi" src="https://raw.githubusercontent.com/spagocci/recensioni/main/perte.mp3" preload="auto"></audio>
<audio id="audioAttivate" src="https://raw.githubusercontent.com/spagocci/recensioni/main/attivate.mp3" preload="auto"></audio>
<audio id="audioDisattivate" src="https://raw.githubusercontent.com/spagocci/recensioni/main/disattivate.mp3" preload="auto"></audio>

<div class="row">
  <div class="column" id="canaleVetrina"><h2>üåàUsato ü´±üèª‚Äçü´≤üèª Spagocci‚≠ê</h2><div class="contenuto" id="contenutoVetrina"></div></div>
  <div class="column" id="canalePerte"><h2>üßê</h2><div class="contenuto" id="contenutoPerte"></div></div>
</div>

<script>
/* ===== Config/API ===== */
const qs = new URLSearchParams(location.search);
const API_BASE = (() => {
  const manual = qs.get('api');
  if (manual) return manual.replace(/\/+$/, '');
  const isHTTPS = location.protocol === 'https:';
  return isHTTPS ? 'https://localhost:' + (qs.get('tls') || '3443')
                 : 'http://localhost:' + (qs.get('port') || '3000');
})();
document.getElementById('apiInfo').textContent = `API: ${API_BASE}`;

/* ===== UI/Status ===== */
const STATUS = document.getElementById('statusMsg');
let BTN_SAVE = document.getElementById('salvaTutto');
function setStatus(msg) { STATUS.textContent = msg; }
function setBusy(b) { if (BTN_SAVE) BTN_SAVE.disabled = b; }

/* ===== Line clamp (righe visibili) ===== */
const clampRange = document.getElementById('clampRange');
const clampVal   = document.getElementById('clampVal');
function applyLineClamp(n){
  const v = Math.max(1, Math.min(12, Number(n)||4));
  document.documentElement.style.setProperty('--line-clamp', String(v));
  if (clampVal) clampVal.textContent = String(v);
  localStorage.setItem('lineClamp', String(v));
}
(function initClamp(){
  const saved = Number(localStorage.getItem('lineClamp') || 4);
  if (clampRange) clampRange.value = String(saved || 4);
  applyLineClamp(saved || 4);
  if (clampRange) clampRange.addEventListener('input', e => applyLineClamp(e.target.value));
})();

/* ===== Stato app ===== */
let audioAttivo = localStorage.getItem('audioAttivo') === 'true';
let messaggiVisualizzati = new Set(JSON.parse(localStorage.getItem('messaggiVisualizzati') || '[]'));
let reorderMode = false;
let DIRTY = false;           // ‚Üê blocca auto-refresh se true
window.__CATALOGO_ORIG = [];
let DATA = [];

/* ===== Canali ===== */
const PERTE_CHANNELS = new Set(['1430829927175032954','1430131174197690479']);
const VETRINA_CHANNEL = '1433444235851468980';

/* ===== Persistenza ordine (cache locale) ===== */
const KEY_VETRINA_ORDER = 'vetrinaOrder';
function readLocalOrderMap(){
  try { return JSON.parse(localStorage.getItem(KEY_VETRINA_ORDER) || '{}') || {}; }
  catch { return {}; }
}
function writeLocalOrderMapFromDOM(){
  const ordine = [...document.querySelectorAll('#contenutoVetrina .item')]
    .map(el=>({asin:el.dataset.asin, position:Number(el.dataset.position)}))
    .filter(o=>o.asin && Number.isFinite(o.position));
  const map = Object.fromEntries(ordine.map(o=>[o.asin, o.position]));
  localStorage.setItem(KEY_VETRINA_ORDER, JSON.stringify(map));
}
function applyOrderMapToData(data, orderMap){
  if (!orderMap || !Object.keys(orderMap).length) return data;
  return data.map(it=>{
    if (it.sourceChannel===VETRINA_CHANNEL && it.asin && orderMap[it.asin]!=null){
      return { ...it, position: Number(orderMap[it.asin]) };
    }
    return it;
  });
}

/* ===== HTTP helpers ===== */
async function getJSON(url, timeout=12000) {
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeout);
  try {
    const res = await fetch(url, { signal: ctrl.signal, cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
    return await res.json();
  } finally { clearTimeout(t); }
}
async function postJSON(url, body, timeout=15000) {
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeout);
  try {
    const res = await fetch(url, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, mode: 'cors',
      body: JSON.stringify(body), signal: ctrl.signal,
    });
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
    catch { return { ok: res.ok, status: res.status, data: { raw:text } }; }
  } finally { clearTimeout(t); }
}
async function putJSON(url, body, timeout=15000) {
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeout);
  try {
    const res = await fetch(url, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' }, mode: 'cors',
      body: JSON.stringify(body), signal: ctrl.signal,
    });
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
    catch { return { ok: res.ok, status: res.status, data: { raw:text } }; }
  } finally { clearTimeout(t); }
}

/* ===== Dati: preferisci locale ‚Üí fallback GitHub ===== */
async function fetchPreferLocal(){
  try {
    const local = await getJSON(`${API_BASE}/data`, 6000);
    if (Array.isArray(local) && local.length >= 0) return local;
  } catch {}
  return await getJSON(`https://spagocci.github.io/recensioni/data.json?t=${Date.now()}`);
}

/* ===== UI base ===== */
const toggleAudioBtn = document.getElementById('toggleAudio');
function aggiornaBottoneAudio(){ toggleAudioBtn.textContent = audioAttivo ? "üîäAudio" : "üîáAudio"; }
aggiornaBottoneAudio();
toggleAudioBtn.addEventListener('click', async () => {
  audioAttivo = !audioAttivo; localStorage.setItem('audioAttivo', audioAttivo); aggiornaBottoneAudio();
  try { await (audioAttivo ? audioAttivate.play() : audioDisattivate.play()); } catch(e){}
});

const filtroInput = document.getElementById('filtroParole');
const mostraInput = document.getElementById('mostraParole');
const clearMostra = document.getElementById('clearMostra');
filtroInput.value = localStorage.getItem('paroleNascondi') || '';
mostraInput.value = localStorage.getItem('mostraParole') || '';
if (mostraInput.value.trim()) clearMostra.style.display='inline-block';
filtroInput.addEventListener('input', ()=>{ localStorage.setItem('paroleNascondi', filtroInput.value.trim()); applicaFiltri(); });
mostraInput.addEventListener('input', ()=>{ localStorage.setItem('mostraParole', mostraInput.value.trim()); clearMostra.style.display = mostraInput.value.trim()? 'inline-block':'none'; applicaFiltri(); });
clearMostra.addEventListener('click', ()=>{ mostraInput.value=''; localStorage.removeItem('mostraParole'); clearMostra.style.display='none'; applicaFiltri(); });
function applicaFiltri(){
  const nascondi = filtroInput.value.toLowerCase().split(/[;,]+/).map(x=>x.trim()).filter(Boolean);
  const mostra   = mostraInput.value.toLowerCase().split(/[;,]+/).map(x=>x.trim()).filter(Boolean);
  document.querySelectorAll('.item').forEach(el=>{
    const testo = (el.innerText||'').toLowerCase();
    const hide = nascondi.some(w=>testo.includes(w));
    const show = (mostra.length===0) || mostra.some(w=>testo.includes(w));
    el.style.display = (!hide && show) ? '' : 'none';
  });
}

/* ===== Helper prezzi ===== */
function normEuro(input){
  const s = String(input||'').trim().replace(/\s*‚Ç¨$/,'').replace(/\s+/g,'').replace(/,/g,'.');
  if (!/^\d+(\.\d+)?$/.test(s)) throw new Error('Valore non valido');
  const n = Number(s); if (!isFinite(n) || n <= 0) throw new Error('Valore non valido');
  return (Number.isInteger(n)? String(n) : n.toFixed(2)).replace('.', ',') + '‚Ç¨';
}
function buildPriceHTML(my, am){
  return `<span style="color:green;font-weight:bold;font-size:1.5em;">Mio: ${my}</span><br><span style="color:red;font-weight:bold;">Valore: ${am}</span>`;
}
function parsePriceHTML(html){
  const tmp = document.createElement('div'); tmp.innerHTML = html || '';
  const text = tmp.textContent || '';
  const m1 = text.match(/mio\s*:\s*([\d.,]+)\s*‚Ç¨?/i);
  const m2 = text.match(/\b(am|amazon)\s*:\s*([\d.,]+)\s*‚Ç¨?/i);
  return {
    my: m1 ? normEuro(m1[1]) : '0‚Ç¨',
    Valore: m2 ? normEuro(m2[2]) : '0‚Ç¨'
  };
}

/* ===== Render ===== */
async function caricaCatalogo(){
  try{
    const raw = await fetchPreferLocal();
    DATA = Array.isArray(raw) ? raw : [];
    window.__CATALOGO_ORIG = DATA.slice();

    const localMap = readLocalOrderMap();
    const data = applyOrderMapToData(window.__CATALOGO_ORIG, localMap);

    const byTimeDesc = (a,b)=> new Date(b.timestamp) - new Date(a.timestamp);
    const byPosTime  = (a,b)=>(a.position??999999)-(b.position??999999) || new Date(b.timestamp)-new Date(a.timestamp);

    const p = document.getElementById('contenutoPerte');
    const v = document.getElementById('contenutoVetrina');
    p.innerHTML = v.innerHTML = '';

    const perte   = data.filter(i=>PERTE_CHANNELS.has(i.sourceChannel)).sort(byTimeDesc);
    const vetRaw  = data.filter(i=>i.sourceChannel===VETRINA_CHANNEL);
    const hasPos  = vetRaw.some(it=>Number.isFinite(Number(it.position)));
    const vetrina = vetRaw.sort(hasPos ? byPosTime : byTimeDesc);

    function renderItem(item, withControls){
      const div = document.createElement('div');
      div.className = 'item';
      const asin = item.asin || '';
      const pos = item.position || '';
      const link = item.link || '';
      div.dataset.asin = asin;
      if (withControls) div.dataset.position = pos || '';

      div.innerHTML = `
        <div class="item-content">
          ${
            item.image
              ? (link ? `<a class="img-link" href="${link}" target="_blank" rel="noopener noreferrer"><img src="${item.image}" alt="" loading="lazy"></a>`
                       : `<img src="${item.image}" alt="" loading="lazy">`)
              : ''
          }
          ${item.price ? `<div class="price-big">${item.price}</div>` : ''}
          <p class="desc">
            ${ link ? `<a href="${link}" target="_blank" rel="noopener noreferrer">${item.text || ''}</a>`
                    : (item.text || '') }
          </p>
          ${!item.price ? `<button class="btn-edit-price" title="Aggiungi prezzo">üí∂ Prezzo</button>` : ''}
          <button class="btn-edit-text" title="Modifica testo">‚úèÔ∏è</button>
          ${withControls ? `<div class="drag-handle" title="Trascina">‚â°</div>` : ''} 
        </div>
        <div class="controls">
          <button class="move-up">‚¨ÜÔ∏è</button>
          <input type="number" min="1" value="${pos || ''}" placeholder="#" class="order-input">
          <button class="move-down">‚¨áÔ∏è</button>
        </div>`;
      return div;
    }

    perte.forEach(it=>{ if (!messaggiVisualizzati.has(it.id)) messaggiVisualizzati.add(it.id); p.appendChild(renderItem(it,false)); });
    vetrina.forEach((it,idx)=>{
      if (!messaggiVisualizzati.has(it.id)) messaggiVisualizzati.add(it.id);
      const el = renderItem(it, reorderMode);
      if (reorderMode){
        if (!el.dataset.position) el.dataset.position = (idx+1).toString();
        const inp = el.querySelector('.order-input'); if (inp && !inp.value) inp.value = el.dataset.position;
      }
      v.appendChild(el);
    });

    localStorage.setItem('messaggiVisualizzati', JSON.stringify([...messaggiVisualizzati]));
    document.getElementById('canaleVetrina').classList.toggle('reorder-on', reorderMode);
    document.getElementById('contenutoVetrina').classList.toggle('drag-enabled', reorderMode);

    enablePointerSort(document.getElementById('contenutoVetrina'), reorderMode);
    applicaFiltri();
  }catch(err){
    ['contenutoPerte','contenutoVetrina']
      .forEach(id => { document.getElementById(id).innerHTML = `<p style="color:red;">‚ùå ${err.message}</p>`; });
  }
}

/* ===== Pointer-based Sort ===== */
const DRAG_THRESHOLD_PX = 12;
let ps = { enabled:false, dragging:false, down:false, origin:null, placeholder:null, ghost:null, startX:0, startY:0, nx:0, ny:0, raf:false };
function enablePointerSort(container, enable){
  container.removeEventListener('pointerdown', onPD);
  window.removeEventListener('pointermove', onPM);
  window.removeEventListener('pointerup', onPU);
  ps = { ...ps, enabled: !!enable, dragging: false, down: false, origin: null, placeholder: null, ghost: null };
  if (!enable) { document.body.classList.remove('reorder-dragging'); return; }
  container.addEventListener('pointerdown', onPD, { passive: true });
  window.addEventListener('pointermove', onPM, { passive: false });
  window.addEventListener('pointerup', onPU, { passive: true });
}
function onPD(e){
  if (!ps.enabled) return;
  const handle = e.target.closest('.drag-handle'); if (!handle) return;
  const item = handle.closest('.item');
  const container = document.getElementById('contenutoVetrina');
  if (!item || item.parentElement !== container) return;
  ps.down = true; ps.dragging = false; ps.origin = item; ps.startX = e.clientX; ps.startY = e.clientY;
}
function startDrag(e){
  if (ps.dragging || !ps.origin) return;
  const item = ps.origin; const r = item.getBoundingClientRect();
  const ph = document.createElement('div'); ph.className = 'placeholder'; ph.style.width  = r.width + 'px'; ph.style.height = r.height + 'px';
  const g = item.cloneNode(true); g.className = 'ghost-drag'; g.style.width = r.width + 'px'; g.style.height = r.height + 'px'; g.style.left = e.clientX + 'px'; g.style.top  = e.clientY + 'px';
  item.parentElement.insertBefore(ph, item); item.style.visibility = 'hidden'; document.body.appendChild(g);
  ps.placeholder = ph; ps.ghost = g; ps.dragging = true; document.body.classList.add('reorder-dragging'); e.preventDefault();
}
function onPM(e){
  if (!ps.enabled || !ps.down) return;
  if (!ps.dragging) {
    const dx = e.clientX - ps.startX; const dy = e.clientY - ps.startY;
    if (Math.abs(dy) > DRAG_THRESHOLD_PX && Math.abs(dy) > Math.abs(dx)) startDrag(e); else return;
  }
  ps.nx = e.clientX; ps.ny = e.clientY;
  if (!ps.raf) { ps.raf = true; requestAnimationFrame(tickMove); }
  e.preventDefault();
}
function tickMove(){
  ps.raf = false; if (!ps.dragging || !ps.ghost) return;
  ps.ghost.style.left = ps.nx + 'px'; ps.ghost.style.top  = ps.ny + 'px';
  const container = document.getElementById('contenutoVetrina');
  const items = [...container.querySelectorAll('.item')].filter(n => n !== ps.origin && n.style.display !== 'none');
  if (!items.length) return;
  const y = ps.ny; let beforeNode = null;
  for (const it of items){ const r = it.getBoundingClientRect(); const mid = r.top + r.height * 0.4; if (y < mid) { beforeNode = it; break; } }
  if (beforeNode) container.insertBefore(ps.placeholder, beforeNode); else container.appendChild(ps.placeholder);
}
function onPU(){
  if (!ps.enabled || !ps.down) return; ps.down = false;
  const container = document.getElementById('contenutoVetrina');
  if (ps.dragging) {
    if (ps.placeholder && ps.origin && ps.placeholder.parentElement === container) { container.insertBefore(ps.origin, ps.placeholder); ps.origin.style.visibility = ''; }
    if (ps.placeholder?.parentElement) ps.placeholder.remove();
    if (ps.ghost?.parentElement) ps.ghost.remove();
    aggiornaPosizioniVetrina();
    writeLocalOrderMapFromDOM();
  }
  document.body.classList.remove('reorder-dragging');
  ps.dragging = false; ps.origin = null; ps.placeholder = null; ps.ghost = null;
}

/* ===== Posizioni ===== */
function aggiornaPosizioniVetrina(){
  const container=document.getElementById('contenutoVetrina');
  const items=[...container.children].filter(n=>n.classList?.contains('item'));
  items.forEach((el,i)=>{ el.dataset.position=i+1; const inp=el.querySelector('.order-input'); if(inp) inp.value=i+1; });
  setDirty(true);
  setStatus('‚úèÔ∏è Riordino in bozza. Clicca SALVA per pubblicare.');
}
function riordinaPerNumeroVetrina(){
  const container=document.getElementById('contenutoVetrina');
  const items=[...container.children].filter(n=>n.classList?.contains('item'))
    .sort((a,b)=>(parseInt(a.dataset.position)||999999)-(parseInt(b.dataset.position)||999999));
  items.forEach(it=>container.appendChild(it));
  setDirty(true);
  setStatus('‚úèÔ∏è Riordino in bozza. Clicca SALVA per pubblicare.');
}

/* ===== Auto-refresh ===== */
let loopOn = true;
(async function aggiornaCatalogoLoop(){
  while(loopOn){
    if (!reorderMode && !DIRTY) await caricaCatalogo();
    await new Promise(r => setTimeout(r, 25000));
  }
})();

/* ===== Dirty state ===== */
function setDirty(v){
  DIRTY = !!v;
  document.getElementById('salvaTutto').style.display = DIRTY ? 'inline-block' : 'none';
  if (DIRTY) localStorage.setItem('__CATALOGO_EDIT', JSON.stringify(DATA));
  else localStorage.removeItem('__CATALOGO_EDIT');
}

/* ===== Edit testo card (‚úèÔ∏è) ===== */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-edit-text');
  if (!btn) return;

  const card = btn.closest('.item');
  const asin = card?.dataset?.asin || '';
  if (!asin) return;

  const linkEl = card.querySelector('.desc a');
  const pEl    = linkEl ? null : card.querySelector('.desc');

  const currentText = linkEl ? (linkEl.textContent || '') : (pEl?.textContent || '');
  const nuovo = prompt(`Nuovo testo per ${asin}`, currentText || '');
  if (nuovo === null) return;

  if (linkEl) linkEl.textContent = nuovo;
  else if (pEl) pEl.textContent = nuovo;

  const rec = DATA.find(x => (x.asin||'').toUpperCase() === asin.toUpperCase());
  if (rec) {
    rec.text = nuovo;
    setDirty(true);
    setStatus('‚úèÔ∏è Testo aggiornato in bozza. Clicca SALVA.');
  }
});

/* ===== Aggiungi prezzo via bottone üí∂ (quando manca) ===== */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-edit-price');
  if (!btn) return;

  const card = btn.closest('.item');
  const asin = card?.dataset?.asin || '';
  if (!asin) return;

  let mio = prompt(`Inserisci "Mio" per ${asin} (es. 33 o 33,99)`, '');
  if (mio === null) return;
  let am  = prompt(`Inserisci "AM" per ${asin} (es. 65 o 65,99)`, '');
  if (am === null) return;

  try {
    mio = normEuro(mio);
    am  = normEuro(am);
  } catch (err) {
    alert(err?.message || err);
    return;
  }

  const rec = DATA.find(x => (x.asin||'').toUpperCase() === asin.toUpperCase());
  if (!rec) return;
  rec.price = buildPriceHTML(mio, am);

  const content = card.querySelector('.item-content');
  let priceBox = content.querySelector('.price-big');
  if (!priceBox) {
    priceBox = document.createElement('div');
    priceBox.className = 'price-big';
    const desc = content.querySelector('.desc');
    content.insertBefore(priceBox, desc);
  }
  priceBox.innerHTML = rec.price;
  btn.remove();

  setDirty(true);
  setStatus('üí∂ Prezzo aggiunto in bozza. Clicca SALVA.');
});

/* ===== Click sul box prezzo per modifiche rapide ===== */
document.addEventListener('click', async (e)=>{
  const priceBox = e.target.closest('.price-big');
  if (!priceBox) return;
  const card = priceBox.closest('.item'); const asin = card?.dataset?.asin || '';
  if (!asin) return;

  const current = parsePriceHTML(priceBox.innerHTML);
  const txt = (e.target.textContent||'').toLowerCase();

  try{
    if (/mio/.test(txt)){
      const v = prompt(`Nuovo "Mio" per ${asin}`, current.my.replace('‚Ç¨','')); if(v===null) return;
      current.my = normEuro(v);
    } else if (/\bam\b|\bamazon\b/.test(txt)){
      const v = prompt(`Nuovo "AM" per ${asin}`, current.am.replace('‚Ç¨','')); if(v===null) return;
      current.am = normEuro(v);
    } else {
      const side = prompt('Scrivi "mio" o "am":','mio'); if(side===null) return;
      const v = prompt(`Nuovo "${side}" per ${asin}`, (side==='mio'?current.my:current.am).replace('‚Ç¨','')); if(v===null) return;
      if (side==='mio') current.my = normEuro(v); else current.am = normEuro(v);
    }
  }catch(err){ alert(err?.message||err); return; }

  const rec = DATA.find(x => (x.asin||'').toUpperCase() === asin.toUpperCase());
  if (rec){
    rec.price = buildPriceHTML(current.my, current.am);
    priceBox.innerHTML = rec.price;
    setDirty(true);
    setStatus('‚úèÔ∏è Prezzo aggiornato in bozza. Clicca SALVA.');
  }
});

/* ===== SALVATAGGIO UNICO: locale + GitHub ===== */
async function salvaTutto(){
  try{
    setBusy(true);
    setStatus('‚è≥ Salvataggio in corso‚Ä¶');

    // 1) sincronizza l‚Äôordine dal DOM ‚Üí DATA.position (solo vetrina)
    const ordine = [...document.querySelectorAll('#contenutoVetrina .item')]
      .map((el,i)=>({ asin: el.dataset.asin, position: Number(el.dataset.position)|| (i+1) }))
      .filter(o => o.asin);

    if (ordine.length){
      const posMap = Object.fromEntries(ordine.map(o => [o.asin.toUpperCase(), o.position]));
      DATA = DATA.map(it => {
        if (String(it.sourceChannel) === VETRINA_CHANNEL && it.asin && posMap[it.asin.toUpperCase()] != null){
          return { ...it, position: posMap[it.asin.toUpperCase()] };
        }
        return it;
      });
      writeLocalOrderMapFromDOM(); // aggiorna cache locale
    }

    // 2) salva localmente
    let r = await putJSON(`${API_BASE}/data`, DATA);
    if (!r.ok || !r.data?.ok) throw new Error(r.data?.error || `HTTP ${r.status}`);

    // 3) pubblica su GitHub
    r = await postJSON(`${API_BASE}/uploadjson`, {});
    if (!r.ok || !r.data?.ok) throw new Error(r.data?.error || `HTTP ${r.status}`);

    setDirty(false);
    setStatus('‚úÖ Salvato e pubblicato su GitHub.');
  }catch(e){
    setStatus('‚ùå Errore salvataggio: ' + (e.message||e));
  }finally{
    setBusy(false);
  }
}
document.getElementById('salvaTutto').addEventListener('click', salvaTutto);

/* ===== Bottoni interni scheda (frecce su/gi√π) ===== */
document.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;

  if(btn.classList.contains('btn-asin')){
    navigator.clipboard.writeText(btn.dataset.asin||''); btn.textContent='üìã Copiato'; setTimeout(()=>btn.textContent='ASIN',1000);
    return;
  }

  if(btn.classList.contains('move-up') || btn.classList.contains('move-down')){
    const item=btn.closest('.item'); const parent=document.getElementById('contenutoVetrina'); if(!item||!parent) return;
    if(btn.classList.contains('move-up') && item.previousElementSibling){ parent.insertBefore(item,item.previousElementSibling); }
    else if(btn.classList.contains('move-down') && item.nextElementSibling){ parent.insertBefore(item.nextElementSibling,item); }
    aggiornaPosizioniVetrina(); writeLocalOrderMapFromDOM();
  }
});

/* ===== Input posizione manuale ===== */
document.addEventListener('input',e=>{
  if(e.target.classList.contains('order-input')){
    const item=e.target.closest('.item'); const pos=parseInt(e.target.value,10);
    if(!isNaN(pos)){ item.dataset.position=pos; riordinaPerNumeroVetrina(); writeLocalOrderMapFromDOM(); }
  }
});

/* ===== Avvio ===== */
window.onload = async () => {
  const draft = localStorage.getItem('__CATALOGO_EDIT');
  if (draft) {
    try { DATA = JSON.parse(draft); window.__CATALOGO_ORIG = DATA.slice(); DIRTY = true; } catch {}
  }
  await caricaCatalogo();
};
</script>

<!-- Console segreta (solo toggle riordino) -->
<div id="secretConsole">
  <form id="secretForm" autocomplete="off">
    <span id="secretPrompt">Console:</span>
    <input id="secretInput" type="password" placeholder="digita comando e premi Invio" />
  </form>
</div>
<script>
  const UNLOCK_KEY = 'reorderUnlocked';

  function ensureReorderButtons() {
    if (document.getElementById('toggleReorder')) return;
    const controls = document.createElement('div');
    controls.innerHTML = `
      <button id="toggleReorder">üéõÔ∏è Riordina Vetrina</button>
    `;
    const statusBar = document.getElementById('statusBar') || document.body;
    statusBar.parentNode.insertBefore(controls, statusBar.nextSibling);

    document.getElementById('toggleReorder').addEventListener('click', () => {
      reorderMode = !reorderMode;
      (window.setStatus || (()=>{}))(reorderMode ? '‚úèÔ∏è Riordino attivo' : '');
      (window.caricaCatalogo || (()=>{}))();
    });
  }

  (function initSecretConsole(){
    const form  = document.getElementById('secretForm');
    const input = document.getElementById('secretInput');
    if (!form || !input) return;

    if (localStorage.getItem(UNLOCK_KEY) === '1') {
      ensureReorderButtons();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const pass = input.value.trim();
      input.value = '';
      if (!pass) return;

      try {
        const resp = await fetch(`${location.origin.includes('https')?'https':'http'}://${location.hostname}:${(new URLSearchParams(location.search).get('port')||'3000')}/unlock`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pass})
        });
        const data = await resp.json().catch(()=>({}));
        if (resp.ok && data?.ok) {
          localStorage.setItem(UNLOCK_KEY, '1');
          ensureReorderButtons();
          if (window.setStatus) window.setStatus('üîì Modalit√† riordino sbloccata');
        } else {
          input.classList.add('error'); setTimeout(()=>input.classList.remove('error'), 600);
          if (window.setStatus) window.setStatus('‚ùå Unlock KO');
        }
      } catch (err) {
        input.classList.add('error'); setTimeout(()=>input.classList.remove('error'), 600);
        if (window.setStatus) window.setStatus('‚ùå Unlock errore di rete');
      }
    });
  })();
</script>
</body>
</html>
