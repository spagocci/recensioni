<!-- /index.html -->
<!DOCTYPE html>
<html lang="it">
<head>
<link rel="icon" href="https://github.com/spagocci/recensioni/blob/main/icona.png" type="image/png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spagocci 1.5.3</title>
<style>
body {font-family:sans-serif;padding:20px;background:#f9f9f9;}
button {margin-bottom:10px;padding:8px 12px;font-size:1em;cursor:pointer;}

/* === INPUT NASCONDI & CERCA === */
#filtroParole {width:100%;max-width:400px;padding:8px 10px;margin:10px 0;font-size:1em;border:2px solid #b30000;border-radius:10px;box-sizing:border-box;}
#mostraBox {position:relative;width:100%;max-width:400px;margin:10px 0;}
#mostraParole {width:100%;padding:8px 10px;font-size:1em;border:2px solid #b30000;border-radius:10px;box-sizing:border-box;}
#clearMostra {position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#b30000;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-weight:bold;display:none;line-height:18px;z-index:1;}
#clearMostra:hover{background:darkred;}

#statusBar {display:flex;align-items:center;gap:15px;margin-bottom:15px;}
#conteggioNascosti {font-weight:bold;color:#b30000;}

/* === LAYOUT === */
.row {display:flex;flex-wrap:wrap;gap:10px;height:auto;}
.column {flex:1 1 300px;background:linear-gradient(to bottom,#fff,#f0f0f0);padding:20px;border-radius:20px;border:none;box-shadow:inset 0 0 10px rgba(0,0,0,0.05),0 4px 10px rgba(0,0,0,0.1);overflow-y:auto;}

/* === OGGETTI === */
.contenuto {display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;padding:0 4px;box-sizing:border-box;}
.item {background:none;border:none;box-shadow:none;padding:5px;display:flex;flex-direction:column;align-items:center;position:relative;}
.item-content {text-align:center;}
.item-content img {width:100%;max-width:200px;aspect-ratio:1/1;object-fit:contain;}
.price-big {font-weight:bold;color:#009900;font-size:1em;}
.column a {color:#000;text-decoration:none;font-weight:bold;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;line-height:1.2em;}
.column a:hover{text-decoration:underline;}
small{color:#666;font-size:0.8em;}

/* === PULSANTE ASIN (micro) === */
.btn-asin{
  position:absolute; right:6px; top:6px;
  border:1px solid #b30000; background:#fff; color:#b30000;
  font-size:10px; line-height:1; padding:3px 5px; border-radius:6px; cursor:pointer;
}
.btn-asin:active{transform:scale(0.98);}

/* === PERFORMANCE === */
img[loading="lazy"] {content-visibility:auto;}

/* === RESPONSIVE MOBILE === */
@media(max-width:768px){
  body{padding:10px;}
  .row{flex-direction:column;}
  .column{flex:1 1 100%;max-width:100%;padding:10px;}
  .contenuto{grid-template-columns:repeat(2,1fr);gap:8px;}
  .item-content img{max-width:110px;}
  .column a{-webkit-line-clamp:4;font-size:0.8em;line-height:1.1em;}
  .price-big{font-size:0.9em;}
  small{font-size:0.7em;}
  h2{font-size:0.9em;margin-bottom:5px;}
}

/* === MODALE === */
#modaleParole{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;}
#modaleContenuto{background:#fff;padding:20px;border-radius:15px;width:90%;max-width:500px;box-shadow:0 0 15px rgba(0,0,0,0.3);}
#modaleContenuto textarea{width:100%;height:120px;font-size:1em;padding:8px;border-radius:8px;border:2px solid #b30000;resize:none;}
#modaleContenuto button{margin-top:10px;margin-right:10px;}
</style>
</head>
<body>
<p class="link-bar">
  <b><a href="https://discord.gg/zE25rQfg">ü§ñDiSCORD</a> -
  <a href="https://sites.google.com/view/davidespagocci/informazioni">üìòiSTRUZiONi</a> -
  <a href="https://whatsapp.com/channel/0029Vb6FyJ88qIzyi9nRtV2O">WHATSAPPüì¶</a> -
  <a href="https://www.ebay.it/sch/i.html?_dkr=1&_ssn=davidespagocci">üõçÔ∏èEBAY</a></b>
</p>

<div id="mostraBox">
  <input id="mostraParole" type="text" placeholder="Cerca Parole (es: Cane, Per Lamborghini)üîç">
  <button id="clearMostra">‚ùå</button>
</div>
<input id="filtroParole" type="text" placeholder="Nascondi Parole (es: Custodia, per finestre)üö´">
<button id="btnGestisciParole">‚úèÔ∏èNascosteü´£</button>
<button id="toggleAudio">üì¢Notifiche</button>
<!-- RIMOSSO: <button id="btnSoloMigliori">...</button> -->

<div id="statusBar">
  <span id="conteggioNascosti">üîï Oggetti nascosti: 0</span>
</div>

<!-- === MODALE === -->
<div id="modaleParole">
  <div id="modaleContenuto">
    <h3>‚úèÔ∏è Parole Nascoste</h3>
    <p>Inserisci parole o frasi separate da virgole o punti e virgola:</p>
    <textarea id="modaleTextarea"></textarea><br>
    <button id="salvaParole">üíæ Salva</button>
    <button id="cancellaParole">üóëÔ∏è Cancella Tutto</button>
    <button id="chiudiModale">‚ùå Chiudi</button>
  </div>
</div>

<!-- === AUDIO (essenziali) === -->
<audio id="audioGenerale" src="https://raw.githubusercontent.com/spagocci/recensioni/main/tutti.mp3" preload="auto"></audio>
<audio id="audioPochiSecondi" src="https://raw.githubusercontent.com/spagocci/recensioni/main/perte.mp3" preload="auto"></audio>
<audio id="audioAttivate" src="https://raw.githubusercontent.com/spagocci/recensioni/main/attivate.mp3" preload="auto"></audio>
<audio id="audioDisattivate" src="https://raw.githubusercontent.com/spagocci/recensioni/main/disattivate.mp3" preload="auto"></audio>

<!-- === COLONNE (solo Vetrina + Perte) === -->
<div class="row">
  <div class="column" id="canaleVetrina"><h2>#vetrina</h2><div class="contenuto" id="contenutoVetrina"></div></div>
  <div class="column" id="canalePerte"><h2>#perte</h2><div class="contenuto" id="contenutoPerte"></div></div>
</div>

<!-- === SCRIPT PRINCIPALE === -->
<script>
window.onload = () => {
  /* === AUDIO NOTIFICHE === */
  let audioAttivo = localStorage.getItem('audioAttivo') === 'true';
  const toggleAudioBtn = document.getElementById('toggleAudio');
  const audioAttivate = document.getElementById('audioAttivate');
  const audioDisattivate = document.getElementById('audioDisattivate');
  function aggiornaBottoneAudio(){ toggleAudioBtn.textContent = audioAttivo ? "üîäAudio" : "üîáAudio"; }
  aggiornaBottoneAudio();
  toggleAudioBtn.addEventListener('click', async () => {
    audioAttivo = !audioAttivo; localStorage.setItem('audioAttivo', audioAttivo); aggiornaBottoneAudio();
    try { if (audioAttivo) await audioAttivate.play(); else await audioDisattivate.play(); } catch(e){}
  });

  /* === CARICAMENTO OGGETTI === */
  const conteggioNascosti = document.getElementById('conteggioNascosti');
  let messaggiVisualizzati = new Set(JSON.parse(localStorage.getItem('messaggiVisualizzati') || '[]'));

  // canali che vanno nella colonna "perte"
  const PERTE_CHANNELS = new Set(['1430829927175032954','1430131174197690479']);

  // Estrae/parsa ASIN
  function extractASIN(item){
    if (item.asin && /^[A-Z0-9]{10}$/.test(item.asin)) return item.asin.toUpperCase();
    const src = item.link || item.text || '';
    if (!src) return null;
    try{
      const u = new URL(src);
      const path = u.pathname;
      const qpAsin = u.searchParams.get('asin');
      if (qpAsin && /^[A-Z0-9]{10}$/i.test(qpAsin)) return qpAsin.toUpperCase();
      const m1 = path.match(/\/(?:dp|gp\/product|product)\/([A-Z0-9]{10})(?:[\/?]|$)/i);
      if (m1) return m1[1].toUpperCase();
    }catch(e){/* non-URL, continua */}
    const m2 = String(src).match(/\b([A-Z0-9]{10})\b/i);
    return m2 ? m2[1].toUpperCase() : null;
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      const ok = document.execCommand('copy'); document.body.removeChild(ta);
      return ok;
    }
  }

  function caricaCatalogo(){
    const t = Date.now();
    return fetch(`https://spagocci.github.io/recensioni/data.json?t=${t}`)
      .then(r => r.ok ? r.json() : Promise.reject(new Error("Errore nel caricamento")))
      .then(data => {
        data.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
        const p = document.getElementById('contenutoPerte');
        const v = document.getElementById('contenutoVetrina');
        p.innerHTML = v.innerHTML = '';

        data.forEach(item => {
          if (!messaggiVisualizzati.has(item.id)) {
            messaggiVisualizzati.add(item.id);
          }
          const asin = extractASIN(item);
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div class="item-content">
              ${
                item.image && item.link
                  ? `<a href="${item.link}" target="_blank" rel="noopener"><img src="${item.image}" alt="" loading="lazy"></a>`
                  : item.image
                    ? `<img src="${item.image}" alt="" loading="lazy">`
                    : ''
              }
              ${item.price ? `<div class="price-big">${item.price}</div>` : ''}
              <p>${item.link ? `<a href="${item.link}" target="_blank" rel="noopener">${item.text}</a>` : item.text}</p>
            </div>
            ${asin ? `<button class="btn-asin" data-asin="${asin}" title="Copia ASIN">ASIN</button>` : ''}`;

          if (PERTE_CHANNELS.has(item.sourceChannel)) {
            p.appendChild(div);
          } else if (item.sourceChannel === '1433444235851468980') { // vetrina
            v.appendChild(div);
          }
        });

        localStorage.setItem('messaggiVisualizzati', JSON.stringify([...messaggiVisualizzati]));
        applicaFiltri();
      })
      .catch(err => {
        ['contenutoPerte','contenutoVetrina']
          .forEach(id => { document.getElementById(id).innerHTML = `<p style="color:red;">‚ùå ${err.message}</p>`; });
      });
  }

  // aggiornamento periodico fisso
  (async function aggiornaCatalogoLoop(){
    while(true){
      await caricaCatalogo();
      await new Promise(r => setTimeout(r, 25000));
    }
  })();

  /* === FILTRI === */
  const filtroInput = document.getElementById('filtroParole');
  const mostraInput = document.getElementById('mostraParole');
  const clearMostra = document.getElementById('clearMostra');
  filtroInput.value = localStorage.getItem('paroleNascondi') || '';
  mostraInput.value = localStorage.getItem('mostraParole') || '';
  if (mostraInput.value.trim()) clearMostra.style.display='inline-block';
  filtroInput.addEventListener('input', ()=>{ localStorage.setItem('paroleNascondi', filtroInput.value.trim()); applicaFiltri(); });
  mostraInput.addEventListener('input', ()=>{ localStorage.setItem('mostraParole', mostraInput.value.trim()); clearMostra.style.display = mostraInput.value.trim()? 'inline-block':'none'; applicaFiltri(); });
  clearMostra.addEventListener('click', ()=>{ mostraInput.value=''; localStorage.removeItem('mostraParole'); clearMostra.style.display='none'; applicaFiltri(); });

  function applicaFiltri(){
    const nascondi = filtroInput.value.toLowerCase().split(/[;,]+/).map(x=>x.trim()).filter(Boolean);
    const mostra   = mostraInput.value.toLowerCase().split(/[;,]+/).map(x=>x.trim()).filter(Boolean);
    let nascosti=0;
    document.querySelectorAll('.item').forEach(el=>{
      const testo = (el.innerText||'').toLowerCase();
      const hide = nascondi.some(w=>testo.includes(w));
      const show = (mostra.length===0) || mostra.some(w=>testo.includes(w));
      el.style.display = (!hide && show) ? '' : 'none';
      if (hide || !show) nascosti++;
    });
    conteggioNascosti.textContent = `üîï Oggetti nascosti: ${nascosti}`;
  }

  /* === MODALE PAROLE === */
  const modale = document.getElementById('modaleParole');
  const textarea = document.getElementById('modaleTextarea');
  const btnGestisci = document.getElementById('btnGestisciParole');
  btnGestisci.addEventListener('click', ()=>{ textarea.value = localStorage.getItem('paroleNascondi') || ''; modale.style.display='flex'; });
  document.getElementById('chiudiModale').addEventListener('click', ()=> modale.style.display='none');
  document.getElementById('salvaParole').addEventListener('click', ()=>{ localStorage.setItem('paroleNascondi', textarea.value.trim()); filtroInput.value = textarea.value.trim(); applicaFiltri(); modale.style.display='none'; });
  document.getElementById('cancellaParole').addEventListener('click', ()=>{ localStorage.removeItem('paroleNascondi'); filtroInput.value=''; applicaFiltri(); modale.style.display='none'; });

  /* === CLICK ASIN (delegato) === */
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.btn-asin');
    if (!btn) return;
    const asin = btn.getAttribute('data-asin');
    if (!asin) return;
    const ok = await copyToClipboard(asin);
    const old = btn.textContent;
    btn.textContent = ok ? 'Copiato!' : 'Errore';
    setTimeout(()=> btn.textContent = old, 900); // feedback breve
  });

  /* RIMOSSO: bottone SoloMigliori e relativa logica */
};
</script>
</body>
</html>
